<% layout('layouts/boilerplate') %>

<style>
  .btn-forgot {
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem;
  }
</style>

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body p-4">
          <h3 class="fw-bold mb-4 text-center">Edit Profile</h3>

          <!-- Flash messages -->
          <% if (errorMessages && errorMessages.length) { %>
            <div class="alert alert-danger">
              <% errorMessages.forEach(msg => { %><p class="mb-0"><%= msg %></p><% }) %>
            </div>
          <% } %>

          <% if (successMessages && successMessages.length) { %>
            <div class="alert alert-success">
              <% successMessages.forEach(msg => { %><p class="mb-0"><%= msg %></p><% }) %>
            </div>
          <% } %>

          <form action="/users/edit" method="POST" class="needs-validation" novalidate>

            <!-- Username -->
            <div class="mb-3">
              <label for="username" class="form-label fw-semibold">Username</label>
              <input 
                type="text" 
                name="username" 
                id="username"
                class="form-control <%= usernameError.length ? 'is-invalid' : '' %>"
                value="<%= user.username %>"
                required>
              <% if (usernameError.length) { %>
                <div class="invalid-feedback"><%= usernameError[0] %></div>
              <% } %>
            </div>

            <!-- Email -->
            <div class="mb-3">
              <label for="email" class="form-label fw-semibold">Email</label>
              <input 
                type="email" 
                name="email" 
                id="email"
                class="form-control <%= emailError.length ? 'is-invalid' : '' %>"
                value="<%= user.email %>"
                required>
              <% if (emailError.length) { %>
                <div class="invalid-feedback"><%= emailError[0] %></div>
              <% } %>
            </div>

            <hr class="my-4">

            <!-- Forgot Password Button -->
            <div class="mb-3 text-center">
              <a href="/forgot" class="btn btn-outline-warning w-100">
                Forgot Password?
              </a>
            </div>

            <!-- Change Password Button -->
            <div class="mb-3 text-center">
              <button type="button" class="btn btn-outline-primary w-100" id="togglePasswordBtn">
                Change / Reset Password
              </button>
            </div>

            <!-- Password Section (hidden by default) -->
            <div id="passwordSection" style="display: none;">

              <!-- Current Password -->
              <div class="mb-3">
                <label for="currentPassword" class="form-label fw-semibold">Current Password</label>
                <input 
                  type="password" 
                  name="currentPassword" 
                  id="currentPassword"
                  class="form-control <%= passwordError.length ? 'is-invalid' : '' %>"
                  placeholder="Enter current password">
                <% if (passwordError.length) { %>
                  <div class="invalid-feedback"><%= passwordError[0] %></div>
                <% } %>
                <div class="invalid-feedback">Please enter a old password</div>
              </div>

              <!-- New Password -->
              <div class="mb-3">
                <label for="newPassword" class="form-label fw-semibold">New Password</label>
                <input 
                  type="password" 
                  name="newPassword" 
                  id="newPassword"
                  class="form-control"
                  placeholder="Enter new password">
                  <div class="invalid-feedback">Please enter a new password</div>
              </div>

              <!-- Confirm Password -->
              <div class="mb-3">
                <label for="confirmPassword" class="form-label fw-semibold">Confirm New Password</label>
                <input 
                  type="password" 
                  name="confirmPassword" 
                  id="confirmPassword"
                  class="form-control"
                  placeholder="Re-enter new password">
                  <div class="invalid-feedback">Passwords do not match</div>
              </div>

            </div>

            <!-- Submit -->
            <button type="submit" class="btn btn-dark w-100 rounded-3 mt-3">Save Changes</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Toggle password section
  const toggleBtn = document.getElementById('togglePasswordBtn');
  const passwordSection = document.getElementById('passwordSection');

  const currentPass = document.getElementById('currentPassword');
  const newPass = document.getElementById('newPassword');
  const confirmPass = document.getElementById('confirmPassword');

  toggleBtn.addEventListener('click', () => {
    if(passwordSection.style.display === 'none') {
      passwordSection.style.display = 'block';
      toggleBtn.textContent = "Cancel Password Change";
      // Make fields required dynamically
      currentPass.required = true;
      newPass.required = true;
      confirmPass.required = true;
    } else {
      passwordSection.style.display = 'none';
      toggleBtn.textContent = "Change / Reset Password";
      // Clear fields & remove invalid classes
      [currentPass, newPass, confirmPass].forEach(el => {
        el.value = '';
        el.classList.remove('is-invalid');
        el.required = false; // Remove required when hidden
      });
    }
  });

  // Form validation
  (function () {
    'use strict'
    const form = document.querySelector('.needs-validation');

    form.addEventListener('submit', function (event) {
      let passwordOpened = passwordSection.style.display !== 'none';
      let invalid = false;

      // Standard Bootstrap validation
      if (!form.checkValidity()) {
        invalid = true;
      }

      // Password section validation if open
      if(passwordOpened) {
        if(!currentPass.value) {
          currentPass.classList.add('is-invalid');
          invalid = true;
        } else {
          currentPass.classList.remove('is-invalid');
        }

        if(!newPass.value) {
          newPass.classList.add('is-invalid');
          invalid = true;
        } else {
          newPass.classList.remove('is-invalid');
        }

        if(!confirmPass.value || newPass.value !== confirmPass.value) {
          confirmPass.classList.add('is-invalid');
          invalid = true;
        } else {
          confirmPass.classList.remove('is-invalid');
        }
      }

      if(invalid) {
        event.preventDefault();
        event.stopPropagation();
      }

      form.classList.add('was-validated');
    }, false);
  })();
</script>
