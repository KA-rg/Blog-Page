<% layout('layouts/boilerplate') %>

<div class="container my-5">

  <!-- Profile Header -->
  <div class="card shadow-sm rounded-4 border-0 mb-4">
    <div class="card-body d-flex flex-column flex-md-row align-items-center">
      <div class="me-md-4 text-center">
        <i class="fa-solid fa-circle-user fa-6x text-secondary"></i>
      </div>
      <div>
        <h2 class="fw-bold mb-1"><%= user.username %></h2>
        <p class="text-muted mb-2"><%= user.email %></p>
        <p class="small text-muted">
          Joined on <%= user.createdAt ? user.createdAt.toDateString() : "N/A" %>
        </p>
        <a href="/users/edit" class="btn btn-outline-dark btn-sm">
          <i class="fa-solid fa-pen me-1"></i> Edit Profile
        </a>
      </div>
    </div>
  </div>

  <!-- My Blogs Section -->
  <div class="mb-5">
    <h3 class="fw-bold mb-3">My Blogs</h3>

    <% if (!blogs || blogs.length === 0) { %>
      <p class="text-muted fst-italic">You haven‚Äôt written any blogs yet.</p>
    <% } else { %>
      <div class="row g-3">
        <% blogs.forEach(blog => { %>
          <div class="col-12 col-md-6 col-lg-4">
            <div class="card shadow-sm rounded-4 border-0 h-100">
              <img src="<%= blog.image?.url || '/images/default.jpg' %>" alt="<%= blog.title %>" class="card-img-top rounded-top-4">
              <div class="card-body">
                <h5 class="card-title">
                  <a href="/blogs/<%= blog._id %>" class="text-dark text-decoration-none"><%= blog.title %></a>
                </h5>
                <p class="card-text text-muted"><%= blog.content.substring(0, 100) %>...</p>

                <!-- Like Button -->
                <button class="btn btn-sm like-btn" data-id="<%= blog._id %>">
                  <span class="heart">
                    <% if (blog.likedBy && blog.likedBy.some(id => id && id.toString() === user._id.toString())) { %>
                      ‚ù§Ô∏è
                    <% } else { %>
                      ü§ç
                    <% } %>
                  </span>
                  <span class="like-count"><%= blog.likes %></span>
                </button>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>

  <!-- My Reviews Section -->
  <div>
    <h3 class="fw-bold mb-3">My Reviews</h3>

    <% if (!reviews || reviews.length === 0) { %>
      <p class="text-muted fst-italic">You haven‚Äôt written any reviews yet.</p>
    <% } else { %>
      <div class="row g-3">
        <% reviews.forEach(review => { %>
          <div class="col-12 col-md-6">
            <div class="card shadow-sm rounded-4 border-0 review-card">
              <div class="card-body">
                <h6 class="card-subtitle mb-2">
                  On 
                  <% if (review.blog) { %>
                    <a href="/blogs/<%= review.blog._id %>" class="fw-bold"><%= review.blog.title %></a>
                  <% } else { %>
                    Blog not available
                  <% } %>
                </h6>
                <p class="starability-result mb-2" data-rating="<%= review.rating %>"></p>
                <p class="card-text"><%= review.comment %></p>
                <small class="text-muted">Posted on <%= review.createdAt ? review.createdAt.toDateString() : "N/A" %></small>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>

</div>

<!-- Like Button JS -->
<script>
  document.querySelectorAll(".like-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const blogId = btn.dataset.id;
      const heart = btn.querySelector(".heart");
      const likeCountSpan = btn.querySelector(".like-count");

      try {
        const res = await fetch(`/blogs/${blogId}/like`, {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        const data = await res.json();

        if (data.success) {
          heart.textContent = data.liked ? "‚ù§Ô∏è" : "ü§ç";
          likeCountSpan.textContent = data.likes;
        } else {
          alert(data.message || "Please login to like!");
          window.location.href = "/login";
        }
      } catch (err) {
        console.error("Like toggle error:", err);
        alert("Failed to update like.");
      }
    });
  });
</script>

<style>
  .review-card {
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .review-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.15);
  }
  .like-btn {
    border: none;
    background: none;
    font-size: 1.2rem;
    cursor: pointer;
  }
  .like-btn .heart {
    transition: transform 0.2s ease-in-out;
  }
  .like-btn:hover .heart {
    transform: scale(1.3);
  }
</style>
